# ==========================
# Dockerfile para JupyterLab con PySpark y MariaDB JDBC
# ==========================

FROM jupyter/pyspark-notebook:spark-3.5.0

USER root

# -----------------------------------------------------------
# 1Ô∏è‚É£ Dependencias b√°sicas
# -----------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl sudo && \
    rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------
# 2Ô∏è‚É£ Variables de entorno para URLs JDBC
# -----------------------------------------------------------
ARG MARIADB_JDBC_URL="https://repo1.maven.org/maven2/org/mariadb/jdbc/mariadb-java-client/3.3.3/mariadb-java-client-3.3.3.jar"
ARG MYSQL_JDBC_URL="https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.4.0/mysql-connector-j-8.4.0.jar"

# -----------------------------------------------------------
# 3Ô∏è‚É£ Descargar conectores JDBC
# -----------------------------------------------------------
RUN mkdir -p /opt/spark/jars && \
    echo "üì• Descargando MariaDB JDBC desde: ${MARIADB_JDBC_URL}" && \
    curl -fL -o /opt/spark/jars/mariadb-java-client.jar "${MARIADB_JDBC_URL}" && \
    echo "üì• Descargando MySQL JDBC desde: ${MYSQL_JDBC_URL}" && \
    curl -fL -o /opt/spark/jars/mysql-connector-j.jar "${MYSQL_JDBC_URL}"

# -----------------------------------------------------------
# 4Ô∏è‚É£ Crear carpetas y ajustar permisos para 'jovyan'
# -----------------------------------------------------------
RUN mkdir -p /home/jovyan/work/shared && \
    chown -R 1000:100 /home/jovyan && \
    chmod -R 777 /home/jovyan && \
    echo "jovyan ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# --- Copiar notebook de ejemplo ---
COPY ./notebooks/sensores_demo.ipynb /home/jovyan/work/sensores_demo.ipynb


# -----------------------------------------------------------
# 5Ô∏è‚É£ Variables de entorno recomendadas
# -----------------------------------------------------------
ENV SPARK_HOME=/usr/local/spark \
    PYSPARK_PYTHON=python3 \
    PYSPARK_DRIVER_PYTHON=jupyter \
    PYSPARK_DRIVER_PYTHON_OPTS="lab --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token=${JUPYTER_TOKEN} --NotebookApp.allow_origin='*'" \
    PATH="$SPARK_HOME/bin:$PATH"

# -----------------------------------------------------------
# 6Ô∏è‚É£ Volvemos al usuario jovyan
# -----------------------------------------------------------
USER jovyan
WORKDIR /home/jovyan/work

# -----------------------------------------------------------
# 7Ô∏è‚É£ Comando de inicio
# -----------------------------------------------------------
ENTRYPOINT ["start-notebook.sh"]
