<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="1100" height="520" viewBox="0 0 1100 520" xmlns="http://www.w3.org/2000/svg">
  <style>
    .title { font: bold 22px sans-serif; }
    .subtitle { font: 15px sans-serif; }
    .box { fill: #f5f5f5; stroke: #424242; stroke-width: 1.5; }
    .box-svc { fill: #e3f2fd; stroke: #1565c0; stroke-width: 1.8; }
    .box-cloud { fill: #fff3e0; stroke: #ef6c00; stroke-width: 1.8; }
    .box-local { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 1.8; }
    .label { font: 14px sans-serif; }
    .small { font: 11px sans-serif; }
    .arrow { stroke: #555555; stroke-width: 1.4; marker-end: url(#arrowhead); fill: none; }
    .step { font: bold 12px sans-serif; fill: #424242; }
    .cloud-border { stroke-dasharray: 8 5; }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
            refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#555555" />
    </marker>
  </defs>

  <!-- Títulos -->
  <text x="550" y="40" text-anchor="middle" class="title">
    Flujo OAuth2 Gmail con n8n + ngrok
  </text>
  <text x="550" y="65" text-anchor="middle" class="subtitle">
    Cómo se usan N8N_WEBHOOK_URL, N8N_HOST, N8N_PROTOCOL y ngrok en BIGDATASTACK
  </text>

  <!-- Zona local -->
  <rect x="40" y="100" width="470" height="380" rx="16" ry="16"
        fill="#fafafa" stroke="#bdbdbd" stroke-width="1.5" />
  <text x="55" y="120" class="small">Host local (Docker + n8n + ngrok)</text>

  <!-- Zona nube -->
  <rect x="590" y="100" width="470" height="380" rx="16" ry="16"
        fill="#fff8e1" stroke="#ffb74d" stroke-width="1.5" class="cloud-border" />
  <text x="605" y="120" class="small">Nube (Google Cloud + APIs Gmail)</text>

  <!-- n8n -->
  <rect x="80" y="150" width="200" height="80" rx="12" ry="12" class="box-local" />
  <text x="180" y="180" text-anchor="middle" class="label">n8n (contenedor)</text>
  <text x="180" y="200" text-anchor="middle" class="small">
    Editor / Webhook interno
  </text>

  <!-- ngrok -->
  <rect x="80" y="270" width="200" height="80" rx="12" ry="12" class="box-svc" />
  <text x="180" y="300" text-anchor="middle" class="label">ngrok</text>
  <text x="180" y="320" text-anchor="middle" class="small">
    Túnel HTTPS → URL pública
  </text>

  <!-- Variables ambiente -->
  <rect x="80" y="370" width="200" height="80" rx="12" ry="12" class="box" />
  <text x="180" y="395" text-anchor="middle" class="label">Variables n8n</text>
  <text x="180" y="413" text-anchor="middle" class="small">
    N8N_WEBHOOK_URL, N8N_HOST,
  </text>
  <text x="180" y="430" text-anchor="middle" class="small">
    N8N_PROTOCOL, N8N_PORT, WEBHOOK_URL...
  </text>

  <!-- Google Cloud -->
  <rect x="640" y="150" width="330" height="80" rx="12" ry="12" class="box-cloud" />
  <text x="805" y="180" text-anchor="middle" class="label">Google Cloud Console</text>
  <text x="805" y="200" text-anchor="middle" class="small">
    Credencial OAuth2 (client_id / client_secret)
  </text>

  <!-- Usuario navegador -->
  <rect x="640" y="270" width="330" height="80" rx="12" ry="12" class="box-svc" />
  <text x="805" y="300" text-anchor="middle" class="label">Navegador del usuario</text>
  <text x="805" y="320" text-anchor="middle" class="small">
    Inicia login Google / da consentimiento
  </text>

  <!-- Gmail API -->
  <rect x="640" y="370" width="330" height="80" rx="12" ry="12" class="box-cloud" />
  <text x="805" y="400" text-anchor="middle" class="label">Google / Gmail API</text>
  <text x="805" y="420" text-anchor="middle" class="small">
    Intercambio de códigos por tokens
  </text>

  <!-- Flechas internas (local) -->
  <line x1="180" y1="230" x2="180" y2="270" class="arrow" />
  <text x="190" y="255" class="step">1. ngrok expone puerto n8n</text>

  <line x1="280" y1="310" x2="640" y2="190" class="arrow" />
  <text x="390" y="230" class="step">2. Controller obtiene URL pública</text>

  <!-- Variables desde ngrok hacia n8n (controller) -->
  <line x1="280" y1="310" x2="280" y2="410" class="arrow" />
  <text x="290" y="360" class="step">3. Exporta N8N_WEBHOOK_URL, HOST, PROTOCOL, PORT</text>

  <line x1="280" y1="410" x2="280" y2="190" class="arrow" />
  <text x="290" y="205" class="step">4. n8n arranca con URL externa correcta</text>

  <!-- Flujo OAuth -->
  <!-- n8n -> Navegador -->
  <line x1="280" y1="190" x2="640" y2="310" class="arrow" />
  <text x="420" y="210" class="step">5. n8n abre URL de consentimiento</text>

  <!-- Navegador -> Google Cloud -->
  <line x1="805" y1="270" x2="805" y2="230" class="arrow" />
  <text x="815" y="255" class="step">6. Redirige a pantalla de login</text>

  <!-- Google Cloud -> Navegador (redirect a ngrok) -->
  <line x1="805" y1="230" x2="805" y2="270" class="arrow" />
  <text x="815" y="245" class="step">7. Usuario acepta / obtiene code</text>

  <!-- Navegador -> n8n (via ngrok) -->
  <line x1="805" y1="350" x2="280" y2="310" class="arrow" />
  <text x="540" y="340" class="step">8. Callback a /rest/oauth2-credential/callback</text>

  <!-- n8n -> Gmail API -->
  <line x1="280" y1="190" x2="640" y2="410" class="arrow" />
  <text x="430" y="390" class="step">9. n8n canjea code por tokens</text>

  <!-- Gmail API -> n8n -->
  <line x1="640" y1="410" x2="280" y2="190" class="arrow" />
  <text x="430" y="260" class="step">10. Tokens guardados en credencial n8n</text>

</svg>
